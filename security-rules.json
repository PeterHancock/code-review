{
  "rules": {
    "users": {
      "$userId" : {
        ".read": "$userId == auth.id",
        ".write": "$userId == auth.id",
        "projects": {
          "$project": {
            "data": {
              ".write": "root.child('users/' + $userId + '/projects/' + $project + '/users/' + auth.id + '/write').exists()",
              ".read": "root.child('users/' + $userId + '/projects/' + $project + '/users/' + auth.id + '/read').exists()"  
            }
          }
        },
        "messages":{
          ".write": "auth != null",
          "$message": {
            ".validate": "newData.hasChildren(['fromId', 'fromEmail', 'fromUUID', 'toUUID', 'message']) && !data.exists()",
            "fromId": {
              ".validate": "newData.val() == auth.id"
            },
            "fromEmail": {
              ".validate": "newData.val() == auth.email"
            },
            "fromUUID": {
              ".validate": "newData.isString()"
            },
            "toUUID": {
              ".validate": "newData.val() == root.child('users/' + $userId + '/private/uuid').val()"
            },
            "message": {
              ".validate": "true"
            },
            "$others": {
              ".validate": "false"
            }
          }
        }
      }
    }
  }
}