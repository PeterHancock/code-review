<!DOCTYPE html>
<html>
    <head>
        <title>Code Review
        </title>
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-theme.min.css">
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.1/underscore-min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/mustache.js/0.7.2/mustache.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js"></script>
        <script type='text/javascript' src='https://cdn.firebase.com/v0/firebase.js'></script>
        <script src="js/shuffle.js"></script>
        <script>
        (function(){

            var CodeReviews = function(firebase) {
                this._firebase = firebase;
                this._constraints = {};
                var scope = this;
                var broadcastChange = _.after(2, function(){
                    scope.trigger('change');
                });
                firebase.child('developers').on('value', function(snapshot) {
                    scope._reviewers = _(snapshot.val()).values() || [];
                    scope._sortReviewers();
                    broadcastChange();
                });
                firebase.child('history').on('value', function(snapshot) {
                    scope._history = _(snapshot.val()).values().reverse() || [];
                    broadcastChange();
                });
            };

            (function(){

                this.getHistory = function() {
                    return this._history;
                }

                this.generate = function() {
                    var active = this.getActiveReviewers();
                    this._generated = shuffle(_(active).pluck('name'), this._history, _.clone(this._constraints));
                    this.trigger('generate');
                }
                this._sortReviewers = function() {
                    this._reviewers = _.sortBy(this._reviewers, function(reviewer) {return reviewer.name.slice(-1)});
                }
                this.commit = function() {
                    if (this._generated) {
                        var gen = this._generated;
                        this._generated = null;
                        this._current = 'placeholder'; //TODO need a better race condition guard!
                        this._current = this._firebase.child('history').push(gen);
                    }
                }

                this.revert = function() {
                    if  (this.canRevert()) {
                        var current = this._current;
                        this._current = null;
                        current.remove();
                    }
                }

                this.canRevert = function() {
                   return this._current ? true : false;
                }

                this.addConstraint = function(reviewerName, revieweeName) {
                    this._constraints[reviewerName] = revieweeName;
                    this.trigger('change');
                }

                this.removeConstraint = function(reviewerName) {
                    delete this._constraints[reviewerName];
                    this.trigger('change');
                }

                this.hasConstraint = function (reviewerName) {
                    return this._constraints[reviewerName] ? true : false;
                }

                this.getReviewers = function() {
                    return this._reviewers;
                }

                this.getActiveReviewers = function() {
                    return _(this.getReviewers()).filter(function(reviewer){ return reviewer.active; });
                }

                this.toggleReviewer = function(reviewer) {
                    if (reviewer.active) {
                        this.removeConstraint(reviewer.name);
                        var pair = _.chain(this._constraints).pairs()
                                    .find(function(pair){ return pair[1] == reviewer.name; })
                                    .value();
                        if (pair) {
                            this.removeConstraint(pair[0]);
                        }
                    }
                    reviewer.active = ! reviewer.active;
                    this.trigger('change');
                }

                this.addReviewer = function(name) {
                    if(_(this._reviewers).find(function(reviewer){ return reviewer.name == name; })) {
                        var message = 'Reviewer ' + name + ' already exists!';
                        this.trigger('error', message);
                        throw message;
                    }
                    this._firebase.child('developers').push({name: name, active: true});
                }

                this.codeReviewTable = function() {
                    return _(this._generated).reduce(function(memo, loop) {
                        _.chain(loop).rest().reduce(function(reviewer, reviewee) {
                            memo[reviewer] = reviewee;
                            return reviewee;
                        }, _(loop).first());
                        memo[_(loop).last()] = _(loop).first();
                        return memo;
                    }, {});
                }

                _(this).extend(Backbone.Events);

            }).call(CodeReviews.prototype);


            // View logic
            function renderGenerate() {
                var tbody = $('<tbody></tbody>');
                var reviewTable = codeReview.codeReviewTable();
                var revieweeTemplate = Mustache.compile($('#reviewee-tmpl').html());
                _(codeReview.getReviewers()).each(function(reviewer){
                    row = $('<tr></tr>');
                    tbody.append(row);
                    var reviewerCell = $('<td/>');
                    var reviewerButton = $('<button class="btn btn-default">' + reviewer.name  + '</button>')
                    row.append(reviewerCell);
                    reviewerCell.append(reviewerButton);
                    reviewerButton.click(function() {
                        codeReview.toggleReviewer(reviewer);
                    });
                    var devCell =  $('<td/>');
                    row.append(devCell);
                    if (reviewer.active) {
                        var reviewee = reviewTable[reviewer.name];
                        var others = _.chain(codeReview.getActiveReviewers()).filter(function(r){
                                return r.name != reviewer.name && r.name != reviewee;
                        }).value();
                        var devButton = $(revieweeTemplate({reviewee: reviewee, others: others}));
                        devCell.append(devButton);
                        reviewerButton.attr('title', 'Remove ' + reviewer.name + ' from next Sprint')
                        var pinButton = devButton.find('.pin');
                        if (codeReview.hasConstraint(reviewer.name)) {
                            pinButton.addClass('btn-warning');
                        }
                        pinButton.click(function(e) {
                            e.preventDefault();
                            pinButton.toggleClass('btn-warning');
                            if (codeReview.hasConstraint(reviewer.name)) {
                                codeReview.removeConstraint(reviewer.name);
                            } else {
                                codeReview.addConstraint(reviewer.name, reviewee);
                            }
                        });
                        _.chain(others).pluck('name').each(function(name) {
                            devButton.find('.pin-to-' + name).click(function(e) {
                                e.preventDefault();
                                codeReview.addConstraint(reviewer.name, name);
                               renderGenerate();
                            });
                        });
                    } else {
                        reviewerButton.attr('title', 'Add ' + reviewer.name + ' to next Sprint')
                                .addClass('btn-warning')
                    }
                    reviewerButton.tooltip();
                });
                $('#review tbody').replaceWith(tbody);
            }

            function renderCurrent() {
                var history = codeReview.getHistory();
                var currentEl = $('#current');
                currentEl.empty();
                var historyLength = history.length;
                $('#sprint-number').text(historyLength);
                if(historyLength > 0) {
                    var current = $('<h2>' + formatSprint(_(history).first()) + '</h2>');
                    currentEl.append(current);
                    if(codeReview.canRevert()) {
                        var removeBtn = $('<button class="btn btn-danger pull-right" title="Revert Sprint"><span class="glyphicon glyphicon-remove"></span></button>');
                        current.append(removeBtn);
                        removeBtn.click(_(codeReview.revert).bind(codeReview));
                        removeBtn.tooltip();
                    }
                } else {
                    currentEl.append('<div class="alert alert-info">There is no Active Sprint</div>');
                }
            }

            function renderHistory() {
                var history = codeReview.getHistory();
                var historyEl = $('#history');
                historyEl.empty();
                var histLength = history.length;
                if (histLength) {
                    _(history).each(function(sprint, i) {
                        var markup = '<strong>' + (histLength - i) + '</strong> ' +formatSprint(sprint);
                        historyEl.append('<li class="list-group-item" style="font-size:1.5em">' + markup + '</li>');
                    });
                } else {
                    historyEl.append('<div class="alert alert-info">There is no Sprint History</div>');
                }
            }

            function renderPage() {
                renderCurrent();
                renderHistory();
                codeReview.generate();
            }

            function renderErrorMessage(message) {

                var msg = $(Mustache.render($('#error-message-tmpl').html(), {message: message})).appendTo($('#error-messages'));
                msg.find('.close').click(function(e){
                    e.preventDefault();
                    msg.remove();
                });
            }

            function formatSprint(sprint) {
                return _(sprint).map(function(loop) {
                    var loop = _.clone(loop);
                    loop.push(_(loop).head());
                    var loopHtml = _(loop).map(function(item) {return '<span>' + item + '</span>'})
                            .join('<span class="glyphicon glyphicon-arrow-right"></span>');
                    return '<span class="label label-default">' + loopHtml + '</span>';
                }).join('    ');
            }


            function init(firebase, reviewers) {
                codeReview = this.codeReview = new CodeReviews(firebase);
                codeReview.on('change', renderPage);
                codeReview.on('generate', renderGenerate);
                codeReview.on('error', renderErrorMessage);
                $('#reshuffle').click(function(){
                    codeReview.generate();
                });
                $('#commit').click(function(){
                    codeReview.commit();
                });
                $('#create-developer-form').submit(function(e) {
                    e.preventDefault();
                    $('#addReviewer').modal('hide');
                    var name = $('#developer-name').val();
                    $('#developer-name').val('');
                    codeReview.addReviewer(name);
                });
                $('.btn').each(function(i, e) {
                    $(e).tooltip();
                });
            }

            $(function(){
                init(new Firebase('code-review.firebaseio.com'));
            });
        }).call(this);
        </script>
    </head>
    <body>
        <div class="container">
            <h1>Code Reviews</h1>
            <div id="error-messages"></div>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3>Current Sprint <span id="sprint-number"></span></h3>
                </div>
                <div id='current' class="panel-body"> </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3><span style="padding-right: 1em">Generate New Sprint</span>
                    <button id="reshuffle" type="button" title="Shuffle Reviewers" class="btn btn-primary btn"><span class="glyphicon glyphicon-random"></span></button>
                    <button id="commit" type="button" class="btn btn-success btn" title="Start Sprint"><span class="glyphicon glyphicon-ok"></span></button>
                    </h3>
                </div>
                <div id="review" class="panel-body">
                    <table class="table">
                        <thead><tr><th>Reviewer</th><th>Developer</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <a data-toggle="modal" href="#addReviewer" class="btn btn-primary" title="Add a Reviewer/Developer"><span class="glyphicon glyphicon-plus"></span></a>
                </div>
          </div>
          <div class="panel panel-default">
                <div class="panel-heading">
                    <h3>Code Review History</h3>
                </div>
                <div class="panel-body">
                    <ul id='history' class='list-group'> </ul>
                </div>
          </div>
     </div>

     <!-- Add Developer Modal -->
     <div class="modal fade" id="addReviewer" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
       <div class="modal-dialog">
         <div class="modal-content">
           <div class="modal-header">
             <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
             <h3 class="modal-title">Add A Developer</h3>
           </div>
           <form action="" method="GET" id="create-developer-form">
           <div class="modal-body">Name
             <input type="text" id="developer-name" required="required" />
           </div>
           <div class="modal-footer">
             <button type="button" class="btn btn-danger" data-dismiss="modal"><span class="glyphicon glyphicon-remove"></span></button>
             <button type="submit" class="btn btn-primary"><span class="glyphicon glyphicon-ok"></span></button>
           </div>
           </form>
         </div>
       </div>
     </div>
    </body>

    <script type="text/template" id="reviewee-tmpl">
    <div class="btn-group reviewee">
        <button type="button" class="btn btn-default pin">{{reviewee}}</button>
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
            <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" role="menu">
            <li><h4>Choose a Developer</h4></li>
            <li class="divider"></li>
            {{#others}}
            <li><a href="#" class="pin-to-{{name}}">{{name}}</a></li>
            {{/others}}
        </ul>
    </div>
    </script>

    <script type="text/template" id="error-message-tmpl">
    <div class="alert">{{message}}<span class="close pull-right">&times;</span></div>
    </script>
</html>

