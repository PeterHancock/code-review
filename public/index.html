<!DOCTYPE html>
<html>
    <head>
        <title>Code Review
        </title>
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-theme.min.css">
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.1/underscore-min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/mustache.js/0.7.2/mustache.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js"></script>
        <script type='text/javascript' src='//cdn.firebase.com/v0/firebase.js'></script>
        <script type='text/javascript' src='//cdn.firebase.com/v0/firebase-simple-login.js'> </script>
        <script type='text/javascript' src='js/login.js'> </script>

        <script>
        (function(){
            var global = this;
            var firebaseRef;
            var authService;
            var events = _({}).extend(Backbone.Events);
            var errorHandler = function(error, msg) {
                events.trigger('error', error, msg);
            };
            function render(user) {
                events.trigger('ready', 'User', user);
                $('#login').text('Logout').click(_.once(function(){
                    $('#main').empty();
                    authService.logout();
                }));
                renderHome(user);
            }
            function renderHome(user) {
                var userNode = firebaseRef.child('users/' + user.id);
                $('#main').empty().load('html/home/info.html', function(){
                        userNode.child('private').on('value', function(snapshot) {
                            var privateInfo = snapshot.val();
                            $('.welcome').text('Welcome ' + user.id +user.email + user.provider + privateInfo.name + privateInfo.uuid);
                        });
                        $('#main .messages').empty()
                        userNode.child('messages').on('value', function(snapshot) {
                            snapshot.forEach(function(snapshot){
                                var message = snapshot.val();
                                if(message.message.type === 'subscribe') {
                                    $('#main .messages').append('<a> Let ' + message.fromEmail + ' join ' + message.message.project + '</a>');
                                } else {
                                    $('#main .messages').append('<div> From:' + message.fromEmail + 'Message:' + message.message + '</div>');
                                }
                            });
                        });
                        $('#main .my-projects').empty();
                        userNode.child('private/my-projects').on('child_added', function(snapshot) {
                            var project = snapshot.val();
                            $('#main .my-projects').append('<div>' + project + '</div>');
                           
                        });
                    });
                
            }
            function renderAnon() {
                events.trigger('ready', 'Anon');
                $('#login').text('Login').click(_.once(function(e){
                    e.preventDefault();
                    authService.login();
                }));
            }
            
            function log () {
                console.log.apply(console, arguments);
            }

            $(function(){
                firebaseRef = global.app = new Firebase('code-review-auth.firebaseio.com');
                authService = AuthService('login-panel', firebaseRef);
                authService.on('auth-error', function(error){
                    errorHandler(error, 'Authentication Error');
                });
                authService
                    .on('auth-user', render)
                    .on('auth-anon', renderAnon)
                    .on('error', log);
                events.on('ready', function(state){
                    log('ready', state);
                });
                authService.authenticate();
            });
        }).call(this);
        </script>
    </head>
    <body>
    <div class="container">
        <span class="welcome">Welcome!</span>
        <a id="login">Login</a>
        <div id="main">Welcome to Code Review</div>
        <div id="login-panel"></div>
    </div>
</body>
</html>

