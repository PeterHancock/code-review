<!DOCTYPE html>
<html>
    <head>
        <title>Code Review
        </title>
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-theme.min.css">
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.1/underscore-min.js"></script>
        <script src="/js/shuffle.js"></script>
        <script>
        (function(){
            var reviewers;
            var history;
            var generated;
            function renderGenerate() {
                var tbody = $('<tbody></tbody>');
                var active = _(reviewers).filter(function(reviewer){ return reviewer.active; });
                var names = _(active).pluck('name');
                var sprint = shuffle(names, history);
                generated = [];
                generated.push.apply(generated, sprint);
                sprint.push(_(sprint).first());
                var reviewTable = _.chain(sprint).rest().reduce(function(memo, next){
                        memo.reviewTable[memo.last] = next
                        memo.last = next
                        return memo
                    }
                    ,{last: _(sprint).first(), reviewTable: {}}).value().reviewTable
                _(reviewers).each(function(reviewer){
                    row = $('<tr></tr>');
                    tbody.append(row);
                    var reviewerCell = $('<td/>');
                    var revToggle = $('<button class="btn">' + reviewer.name  + '</button>')
                    row.append(reviewerCell);
                    reviewerCell.append(revToggle);
                    revToggle.click(function() {
                        reviewer.active = ! reviewer.active;
                        renderGenerate();
                    });
                    var devCell =  $('<td/>');
                    row.append(devCell);
                    if (reviewer.active) {
                        var devName = reviewTable[reviewer.name];
                        var devButton = $('<button class="btn btn-success">' + devName + '</button>');
                        devCell.append(devButton);
                        devButton.click(function() {
                            _(active).find(function(per) {return per.name == devName; }).active = false;
                            renderGenerate();
                        });
                        revToggle.addClass('btn-success');
                    } else {
                        revToggle.addClass('btn-warning')
                    }
                });
                $('#review tbody').replaceWith(tbody);
            }
            function renderCurrent() {
                var currentEl = $('#current');
                currentEl.empty();
                var historyLength = history.length;
                if(historyLength > 0) {
                    var current = $('<div> <strong>Sprint ' + historyLength + ':</strong> ' + formatSprint(_(history).first()) + '</div>');
                    currentEl.append(current);
                    var removeBtn = $('<button class="btn btn-danger pull-right" title="Revert Sprint"><span class="glyphicon glyphicon-remove"></span></button>');
                    current.append(removeBtn);
                    removeBtn.click(deleteCurrent);
                    removeBtn.hover(function(){removeBtn.tooltip()});
                } else {
                    currentEl.append('<div class="alert alert-info">There is no Active Sprint</div>');
                }
            }
            function deleteCurrent() {
              history=_(history).rest();
              renderPage();
            }
            function renderHistory() {
                var historyEl = $('#history');
                historyEl.empty();
                var histLength = history.length;
                if (histLength) {
                    _(history).each(function(sprint, i) {
                        var markup = '<strong>' + (histLength - i) + '</strong> ' +formatSprint(sprint);
                        historyEl.append('<li class="list-group-item">' + markup + '</li>');
                    });
                } else {
                    historyEl.append('<div class="alert alert-info">There is no Sprint History</div>');
                }
            }
            function renderPage() {
                generated = null;
                renderCurrent();
                renderGenerate();
                renderHistory();
            }
            function formatSprint(sprint) {
               var ns = [];
               ns.push.apply(ns, sprint);
               ns.push(_(ns).first());
               return _(ns).map(function(item) {return '<span class="label label-success">' + item+ '</span>'})
                       .join('<span class="glyphicon glyphicon-arrow-right"></span>');
            }
            $(function(){
                var names = _.sortBy(window.location.search.substr(1).split(','), function(reviewer) { return reviewer.slice(-1) });
                history = [];
                reviewers = _(names).map(function(name) { return {name: name, active: true} });
                renderPage();
                $('#reshuffle').click(function(){
                    renderGenerate();
                });
                $('#commit').click(function(){
                    var newHistory = [generated];
                    newHistory.push.apply(newHistory, history);
                    history = newHistory;
                    renderPage();
                });
            });
        }).call(this);
        </script>
    </head>
    <body>
        <div class="container">
            <h1>Code Reviewers</h1>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3>Current Sprint</h3>
                </div>
                <div id='current' class="panel-body"> </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3>Generate New Sprint</h3>
                </div>
                <div id="review" class="panel-body">
                    <table class="table">
                        <thead><tr><th>Reviewer</th><th>Developer</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            <button id="reshuffle" type="button" class="btn btn-primary">Reshuffle</button>
            <button id="commit" type="button" class="btn btn-primary">Commit</button>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3>Code Review History</h3>
                </div>
                <div class="panel-body">
                    <ul id='history' class='list-group'> </ul>
                </div>
            </div>
        </div>
    </body>
</html>

