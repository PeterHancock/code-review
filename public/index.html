<!DOCTYPE html>
<html>
    <head>
        <title>Code Review
        </title>
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-theme.min.css">
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.1/underscore-min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.ba-bbq/1.2.1/jquery.ba-bbq.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/mustache.js/0.7.2/mustache.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js"></script>
        <script type='text/javascript' src='//cdn.firebase.com/v0/firebase.js'></script>
        <script type='text/javascript' src='//cdn.firebase.com/v0/firebase-simple-login.js'> </script>
        <script type='text/javascript' src='js/util/uuid.js'> </script>
        <script type='text/javascript' src='js/FirebaseService.js'> </script>
        <script type='text/javascript' src='js/login.js'> </script>
        <script type='text/javascript' src='js/messaging.js'> </script>
        <script src="js/shuffle.js"></script>
        <script src="js/project.js"></script>

        <script>
        (function(){
            var global = this;
            var firebaseRef;
            var authService;
            var messageService;
            var user;
            var events = _({}).extend(Backbone.Events);
            var errorHandler = function(error, msg) {
                events.trigger('error', error, msg);
            };

            $(function(){
                firebaseRef = global.app = new FirebaseService('code-review-auth');
                authService = AuthService('login-panel', firebaseRef);
                authService.on('auth-error', function(error){
                    errorHandler(error, 'Authentication Error');
                });
                authService
                    .on('auth-user', renderApp)
                    .on('auth-user-created', userCreated)
                    .on('auth-anon', renderAnon)
                    .on('auth-error', log)
                    .on('user-created-error', log);

                events.on('ready', function(state){
                    log('ready', state);
                });
                authService.authenticate();
            });

            function userCreated(user, created) {
                var userNode = firebaseRef.getUserRef(user);
                created.uuid = guid();
                userNode.child('private').set({name: created.name, uuid: created.uuid});
                _(user).extend(created);
                renderPage(user);
            }

            function renderApp(u) {
                user = u;
                events.trigger('ready', 'User', user);

                $('#login').text('Logout').click(_.once(function(){
                    $('#main').empty();
                    $('.welcome').text('Welcome!');
                    authService.logout();
                }));
                var userNode = firebaseRef.getUserRef(user);
                userNode.child('private').on('value', function(snapshot) {
                    var privateInfo = snapshot.val();
                    _(user).extend(privateInfo);
                    $('.welcome').text('Welcome ' + user.email + ' (' + user.id + ':' + user.provider + ' "' +  user.name + '" uuid:'+  user.uuid + ')');
                    messageService = new MessageService(firebaseRef, user);
                    renderPage();
                });
            }

            function renderPage() {
                 var fragment = $.param.fragment() ? $.deparam.fragment() : {action: 'home'};
                 var render = Render[fragment.action] || Render.home;
                 render.call(this, fragment);
                 $('a.fragnav').click(fragnavClick);
            }

            function fragnavClick(e) {
                location.hash = '#' + this.href.split('#')[1];
                renderPage();
                e.preventDefault();
            }


            function accept(user,  message) {
                messageService.reply(message, {
                            type: "accept",
                            project : {
                                id: message.message.project,
                                name: message.message.name,
                                org: message.message.org,
                                user: {id: user.id, provider: user.provider}
                            }
                 });
                 firebaseRef.getUserRef(user).child('projects/' + message.message.project + '/users/' + firebaseRef.getId(message.from) + '/read').set(true);
            }

            var Render = {
                home: function() {
                    var userNode = firebaseRef.getUserRef(user);
                    $('#main').empty().load('html/home/info.html', function(){
                        messageService.on('message_added', function(message){
                            switch(message.message.type) {
                                case 'subscribe':
                                    userNode.child('projects/' + message.message.project + '/details').on('value', function(s){
                                        var projectDetails = s.val();
                                        _(message.message).extend(projectDetails);
                                        $('<p><a> Let ' + message.from.email + ' join ' + projectDetails.name + '</a></p>').appendTo('#main .messages')
                                            .click(_.once(function(e){
                                                e.preventDefault();
                                                accept(user, message);
                                                $(this).remove();
                                                message.remove();
                                            }));
                                    });

                                    break;
                                case 'accept':
                                     firebaseRef.getUserRef(user).child('private/subscribed-projects').push(message.message.project);
                                    message.remove();
                                    break;
                                default:
                                    $('#main .messages').append('<p> From:' + message.from.email + 'Message:' + message.message + '</p>');
                            }
                        });

                        $('#main .my-projects').empty();
                        userNode.child('projects').on('child_added', function(snapshot) {
                            var project = snapshot.val();
                            var projectDetail = {
                                id: snapshot.name(),
                                org: project.details.org,
                                name: project.details.name
                            };
                            $('<p>').append(projectLink(projectDetail, user)).appendTo($('#main .my-projects'));

                        });
                        $('#main .subscribed-projects').empty();
                        userNode.child('private/subscribed-projects').on('child_added', function(snapshot) {
                            var project = snapshot.val();
                            $('<p>').append(projectLink(project, project.user)).appendTo($('#main .subscribed-projects'));

                        });
                        messageService.listen();
                    });
                },
                project: function(context) {
                    window.renderProject(firebaseRef.getUserRef(context).child('projects/' + context.projectId), '#main', context.name);
                },
                /*
                * Invitation to subscribe to a project
                */
                invite: function(context) {
                    messageService.send(context, { type: "subscribe", project: context.project});
                    Render.home(user, context);
                }
            }

            function projectLink(project, user){
                return appLink('<a class="fragnav" href="#action=project&projectId=' + project.id + '&id=' + user.id + '&provider=' + user.provider +'">' + project.org + '/' + project.name + '</a>');
            }

            function appLink(markup) {
                return $(markup).click(fragnavClick);
            }

            function renderAnon() {
                events.trigger('ready', 'Anon');
                $('#login').text('Login').click(function(e){
                    e.preventDefault();
                    authService.login();
                });
            }

            function log () {
                console.log.apply(console, arguments);
            }

        }).call(this);
        </script>
    </head>
    <body>
    <nav class="navbar navbar-default" role="navigation">
      <!-- Brand and toggle get grouped for better mobile display -->
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand fragnav" href="#">Code Review</a>
      </div>

      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse navbar-collapse navbar-ex1-collapse">
        <ul class="nav navbar-nav navbar-right">
        <li><p class="navbar-text welcome">Welcome!</p></li>
        <li><a id="login">Login</a></li>
        </ul>
      </div><!-- /.navbar-collapse -->
    </nav>
    <div class="container">
        <div id="main">Welcome to Code Review</div>
        <div id="login-panel"></div>
    </div>
</body>
</html>

