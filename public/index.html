<!DOCTYPE html>
<html>
    <head>
        <title>Code Review
        </title>
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-theme.min.css">
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.1/underscore-min.js"></script>
        <script src="/js/shuffle.js"></script>
        <script>
        (function(){
            var reviewers;
            var history;
            var generated;
            function renderGenerate() {
                var tbody = $('<tbody></tbody>');
                var active = _(reviewers).filter(function(reviewer){ return reviewer.active; });
                var names = _(active).pluck('name');
                var sprint = shuffle(names, history);
                generated = [];
                generated.push.apply(generated, sprint);
                sprint.push(_(sprint).first());
                var reviewTable = _.chain(sprint).rest().reduce(function(memo, next){
                        memo.reviewTable[memo.last] = next
                        memo.last = next
                        return memo
                    }
                    ,{last: _(sprint).first(), reviewTable: {}}).value().reviewTable
                _(reviewers).each(function(reviewer){
                    row = $('<tr></tr>');
                    tbody.append(row);
                    var reviewerCell = $('<td/>');
                    var revToggle = $('<button class="btn btn-default">' + reviewer.name  + '</button>')
                    row.append(reviewerCell);
                    reviewerCell.append(revToggle);
                    revToggle.click(function() {
                        reviewer.active = ! reviewer.active;
                        renderGenerate();
                    });
                    var devCell =  $('<td/>');
                    row.append(devCell);
                    if (reviewer.active) {
                        var devName = reviewTable[reviewer.name];
                        var devButton = $('<button class="btn btn-default">' + devName + '</button>');
                        devCell.append(devButton);
                        revToggle.attr('title', 'Remove ' + reviewer.name + ' from new Sprint')
                        devButton.click(function() {
                            _(active).find(function(per) {return per.name == devName; }).active = false;
                            renderGenerate();
                        });
                        devButton.attr('title', 'Remove ' + devName + ' from new Sprint');
                        devButton.tooltip();
                    } else {
                        revToggle.attr('title', 'Add ' + reviewer.name + ' to new Sprint')
                        revToggle.addClass('btn-warning')
                    }
                    revToggle.tooltip();
                });
                $('#review tbody').replaceWith(tbody);
            }
            function renderCurrent() {
                var currentEl = $('#current');
                currentEl.empty();
                var historyLength = history.length;
                $('#sprint-number').text(historyLength);
                if(historyLength > 0) {
                    var current = $('<div style="font-size:1.5em">' + formatSprint(_(history).first()) + '</div>');
                    currentEl.append(current);
                    var removeBtn = $('<button class="btn btn-danger pull-right" title="Revert Sprint"><span class="glyphicon glyphicon-remove"></span></button>');
                    current.append(removeBtn);
                    removeBtn.click(deleteCurrent);
                    removeBtn.tooltip();
                } else {
                    currentEl.append('<div class="alert alert-info">There is no Active Sprint</div>');
                }
            }
            function deleteCurrent() {
              history=_(history).rest();
              renderPage();
            }
            function renderHistory() {
                var historyEl = $('#history');
                historyEl.empty();
                var histLength = history.length;
                if (histLength) {
                    _(history).each(function(sprint, i) {
                        var markup = '<strong>' + (histLength - i) + '</strong> ' +formatSprint(sprint);
                        historyEl.append('<li class="list-group-item" style="font-size:1.5em">' + markup + '</li>');
                    });
                } else {
                    historyEl.append('<div class="alert alert-info">There is no Sprint History</div>');
                }
            }
            function renderPage() {
                generated = null;
                renderCurrent();
                renderGenerate();
                renderHistory();
            }
            function formatSprint(sprint) {
               var ns = [];
               ns.push.apply(ns, sprint);
               ns.push(_(ns).first());
               return _(ns).map(function(item) {return '<span class="label label-default">' + item+ '</span>'})
                       .join('<span class="glyphicon glyphicon-arrow-right"></span>');
            }

            function sortReviewers() {
                reviewers = _.sortBy(reviewers, function(reviewer) {return reviewer.name.slice(-1)});
            }

            $(function(){
                var names = window.location.search.substr(1).split(',');
                history = [];
                reviewers = _(names).map(function(name) { return {name: name, active: true} });
                sortReviewers();
                renderPage();
                $('#reshuffle').click(function(){
                    renderGenerate();
                });
                $('#commit').click(function(){
                    var newHistory = [generated];
                    newHistory.push.apply(newHistory, history);
                    history = newHistory;
                    renderPage();
                });
                $('#create-developer-form').submit(function(e) {
                    e.preventDefault();
                    var name = $('#developer-name').val();
                    reviewers.push({name:name, active: true});
                    sortReviewers();
                    $('#addReviewer').modal('hide');
                    renderPage();
                });
                $('.btn').each(function(i, e) {
                    $(e).tooltip()});
                });
        }).call(this);
        </script>
    </head>
    <body>
        <div class="container">
            <h1>Code Reviews</h1>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3>Current Sprint <span id="sprint-number"></span></h3>
                </div>
                <div id='current' class="panel-body"> </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3><span style="padding-right: 1em">Generate New Sprint</span>
                    <button id="reshuffle" type="button" title="Shuffle Reviewers" class="btn btn-primary btn"><span class="glyphicon glyphicon-random"></span></button>
                    <button id="commit" type="button" class="btn btn-success btn" title="Start Sprint"><span class="glyphicon glyphicon-ok"></span></button>
                    </h3>
                </div>
                <div id="review" class="panel-body">
                    <table class="table">
                        <thead><tr><th>Reviewer</th><th>Developer</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <a data-toggle="modal" href="#addReviewer" class="btn btn-primary" title="Add a Reviewer/Developer"><span class="glyphicon glyphicon-plus"></span></a>
                </div>
          </div>
          <div class="panel panel-default">
                <div class="panel-heading">
                    <h3>Code Review History</h3>
                </div>
                <div class="panel-body">
                    <ul id='history' class='list-group'> </ul>
                </div>
          </div>
     </div>

     <!-- Add Developer Modal -->
     <div class="modal fade" id="addReviewer" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
       <div class="modal-dialog">
         <div class="modal-content">
           <div class="modal-header">
             <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
             <h3 class="modal-title">Add A Developer</h3>
           </div>
           <form action="" method="GET" id="create-developer-form">
           <div class="modal-body">Name
             <input type="text" id="developer-name" required="required" />
           </div>
           <div class="modal-footer">
             <button type="button" class="btn btn-danger" data-dismiss="modal"><span class="glyphicon glyphicon-remove"></span></button>
             <button type="submit" class="btn btn-primary"><span class="glyphicon glyphicon-ok"></span></button>
           </div>
           </form>
         </div>
       </div>
     </div>
    </body>
</html>

